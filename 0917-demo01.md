# 0917 Practice - Demo01

### 預期結果

```
Demo3Test

package com.uuu.demo1;

import org.hamcrest.Matchers;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.assertj.MockMvcTester;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;

@SpringBootTest
@AutoConfigureMockMvc
public class Demo3Test {
    @Autowired
    private MockMvc mockMvc;

    @Test
    public void checkDemoControllerNotNull() {
        Assertions.assertNotNull(mockMvc);
    }

    @Test
    public void testHomeIsOk() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().isOk());
    }

    @Test
    public void testHomeIs2XX() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful());
    }

    @Test
    public void testRootShouldReturnHome() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("home"));
    }
    @Test
    public void testRootShouldReturnHomeContainsThymeleaf() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("home"))
                .andExpect(MockMvcResultMatchers.content().string(Matchers.containsString("thymeleaf")));
    }
    @Test
    public void testInfoShouldReturnCorrectName() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/info"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("info/contact"));
    }

    @Test
    public void testAdminIsNotFound() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/admin"))
                .andExpect(MockMvcResultMatchers.status().isNotFound());
    }

    @Test
    public void testAdminIs4XXClientSideError() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/admin"))
                .andExpect(MockMvcResultMatchers.status().is4xxClientError());
    }
}
```

### 使用 @WebMvcTest 測Web

```
Demo4Test (NEW)

package com.uuu.demo1;

import com.uuu.demo1.controllers.DemoController;
import com.uuu.demo1.controllers.FakeController;
import org.hamcrest.Matchers;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;

//@WebMvcTest(controllers = {DemoController.class})
@WebMvcTest
public class Demo4Test {
    @Autowired
    private MockMvc mockMvc;

    @Test
    public void checkDemoControllerNotNull() {
        Assertions.assertNotNull(mockMvc);
    }

    @Test
    public void testHomeIsOk() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().isOk());
    }

    @Test
    public void testHomeIs2XX() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful());
    }

    @Test
    public void testRootShouldReturnHome() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("home"));
    }

    @Test
    public void testRootShouldReturnHomeContainsThymeleaf() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("home"))
                .andExpect(MockMvcResultMatchers.content().string(Matchers.containsString("thymeleaf")));
    }

    @Test
    public void testInfoShouldReturnCorrectName() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/info"))
                .andExpect(MockMvcResultMatchers.status().is2xxSuccessful())
                .andExpect(MockMvcResultMatchers.view().name("info/contact"));
    }

    @Test
    public void testAdminIsNotFound() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/admin"))
                .andExpect(MockMvcResultMatchers.status().isNotFound());
    }

    @Test
    public void testAdminIs4XXClientSideError() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/admin"))
                .andExpect(MockMvcResultMatchers.status().is4xxClientError());
    }
}
```

### 增加服務元件 @Service

```java
GreetingService.java

package com.uuu.demo1.services;

import org.springframework.stereotype.Service;

@Service
public class GreetingService {
    public String greet() {
        return "Hello, this is my first spring boot service";
    }
}
```

```java
GreetController.java

package com.uuu.demo1.controllers;

import com.uuu.demo1.services.GreetingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class GreetController {
    @Autowired
    private GreetingService service;

    @RequestMapping("/greeting")
    public @ResponseBody String greeting() {
        return service.greet();
    }
}
```

<img width="423" height="163" alt="{1FED29F6-0071-48CA-B95E-6CC8B3A10ACA}" src="https://github.com/user-attachments/assets/bad031fd-db12-4208-99d0-d49b126662a0" />

會導致 Demo4Test 案例失敗，需重新加上@WebMvcTest(controllers = {DemoController.class})  
<img width="1237" height="270" alt="{4ECE1483-D4F1-4A1F-880F-1F9269B1D4D1}" src="https://github.com/user-attachments/assets/613ea1ea-654e-4c6b-89c8-4a5efa1e14a9" />
<img width="1050" height="355" alt="{85B98327-CD95-4BC0-9BFF-3A91CB62543F}" src="https://github.com/user-attachments/assets/aa1dc046-edb1-4b14-ad27-8788414682af" />

### 使用 @MockitoBean

```
Demo5Test (NEW)

package com.uuu.demo1;

import com.uuu.demo1.controllers.GreetController;
import com.uuu.demo1.services.GreetingService;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

//@SpringBootTest
//@AutoConfigureMockMvc
@WebMvcTest(controllers = GreetController.class)
public class Demo5Test {
    @Autowired
    private MockMvc mockMvc;
    @MockitoBean
    private GreetingService service;

    @Test
    public void mockMvcShouldNotNull() {
        Assertions.assertNotNull(mockMvc);
    }
}
```

### 

```
Demo5Test

package com.uuu.demo1;

import com.uuu.demo1.controllers.GreetController;
import com.uuu.demo1.services.GreetingService;
import org.hamcrest.Matchers;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.result.MockMvcResultHandlers;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;

//@SpringBootTest
//@AutoConfigureMockMvc
@WebMvcTest(controllers = GreetController.class)
public class Demo5Test {
    @Autowired
    private MockMvc mockMvc;
    @MockitoBean
    private GreetingService service;

    @Test
    public void mockMvcShouldNotNull() {
        Assertions.assertNotNull(mockMvc);
    }

    @Test
    public void performGreet() throws Exception {
        String testString = "hello world";
        Mockito.when(service.greet()).thenReturn(testString);
        mockMvc.perform(MockMvcRequestBuilders.get("/greeting"))
                .andExpect(MockMvcResultMatchers.status().isOk())
                .andDo(MockMvcResultHandlers.print())
                .andExpect(MockMvcResultMatchers.content().string(
                        Matchers.containsString(testString)
                ))
        ;
    }
}
```

### 使用Bean Validation - @NotNull

```java
NormalUser1.java

package com.uuu.demo1.beans;

import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class NormalUser1 {
    @NotNull(message = "name may not be null")
    private String name;
}
```

```java
Demo6Test

package com.uuu.demo1;

import com.uuu.demo1.beans.NormalUser1;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.Validation;
import jakarta.validation.Validator;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import java.util.Set;

//import javax.xml.validation.Validator;

public class Demo6Test {
    private static Validator validator;

    @BeforeAll
    public static void prepareValidator() {
        validator = Validation.buildDefaultValidatorFactory().getValidator();
    }

    @Test
    public void createNormalUser1() {
        NormalUser1 user = new NormalUser1();
        Assertions.assertNull(user.getName());
    }

    @Test
    public void checkNullAssertionShouldTrigger() {
        NormalUser1 user = new NormalUser1();
        Set<ConstraintViolation<NormalUser1>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkEmptyIsNull() {
        NormalUser1 user = new NormalUser1();
        user.setName("");
        Set<ConstraintViolation<NormalUser1>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
    @Test
    public void checkSpaceIsNull() {
        NormalUser1 user = new NormalUser1();
        user.setName("     \t");
        Set<ConstraintViolation<NormalUser1>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
    @Test
    public void checkStuffIsNull() {
        NormalUser1 user = new NormalUser1();
        user.setName("www.uuu.com.tw");
        Set<ConstraintViolation<NormalUser1>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
}
```

### 使用Bean Validation - @NotEmpty

```java
NormalUser2.java

package com.uuu.demo1.beans;

import jakarta.validation.constraints.NotEmpty;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class NormalUser2 {
    @NotEmpty(message = "name may not be empty")
    private String name;
}
```

```java
Demo7Test

package com.uuu.demo1;

import com.uuu.demo1.beans.NormalUser2;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.Validation;
import jakarta.validation.Validator;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import java.util.Set;

public class Demo7Test {
    private static Validator validator;

    @BeforeAll
    public static void prepareValidator() {
        validator = Validation.buildDefaultValidatorFactory().getValidator();
    }

    @Test
    public void createNormalUser2() {
        NormalUser2 user = new NormalUser2();
        Assertions.assertNull(user.getName());
    }

    @Test
    public void checkNullAssertionShouldTrigger() {
        NormalUser2 user = new NormalUser2();
        Set<ConstraintViolation<NormalUser2>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkEmptyIsNull() {
        NormalUser2 user = new NormalUser2();
        user.setName("");
        Set<ConstraintViolation<NormalUser2>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkSpaceIsNull() {
        NormalUser2 user = new NormalUser2();
        user.setName("     \t");
        Set<ConstraintViolation<NormalUser2>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
    @Test
    public void checkStuffIsNull() {
        NormalUser2 user = new NormalUser2();
        user.setName("www.uuu.com.tw");
        Set<ConstraintViolation<NormalUser2>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
}
```

### 使用Bean Validation - @NotBlank

```java
NormalUser3.java

package com.uuu.demo1.beans;

import jakarta.validation.constraints.NotBlank;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class NormalUser3 {
    @NotBlank(message = "name may not be blank")
    private String name;
}

```

```java
Demo8Test

package com.uuu.demo1;

import com.uuu.demo1.beans.NormalUser3;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.Validation;
import jakarta.validation.Validator;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import java.util.Set;

//import javax.xml.validation.Validator;

public class Demo8Test {
    private static Validator validator;

    @BeforeAll
    public static void prepareValidator() {
        validator = Validation.buildDefaultValidatorFactory().getValidator();
    }

    @Test
    public void createNormalUser3() {
        NormalUser3 user = new NormalUser3();
        Assertions.assertNull(user.getName());
    }

    @Test
    public void checkNullAssertionShouldTrigger() {
        NormalUser3 user = new NormalUser3();
        Set<ConstraintViolation<NormalUser3>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkEmptyIsNull() {
        NormalUser3 user = new NormalUser3();
        user.setName("");
        Set<ConstraintViolation<NormalUser3>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkSpaceIsNull() {
        NormalUser3 user = new NormalUser3();
        user.setName("     \t");
        Set<ConstraintViolation<NormalUser3>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(1, violations.size());
    }
    @Test
    public void checkStuffIsNull() {
        NormalUser3 user = new NormalUser3();
        user.setName("www.uuu.com.tw");
        Set<ConstraintViolation<NormalUser3>> violations = validator.validate(user);
        for (var v : violations) {
            System.out.printf("find a violation:%s\n", v.getMessage());
        }
        Assertions.assertEquals(0, violations.size());
    }
}
```

### 表單 Form

```java
CourseForm (NEW)

package com.uuu.demo1.forms;

import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class CourseForm {
    @NotEmpty
    @Size(min = 5, max = 30)
    private String courseId;
    @NotEmpty
    private String courseName;
    @NotNull
    @Min(7)
    private Integer duration;
}
```

```html
courseForm.html (NEW)

<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Course Form</title>
</head>
<body>
<h1>課程表單</h1>
<p>debug info:[[${courseForm}]]</p>
</body>
</html>
```

```java
CourseController (NEW)

package com.uuu.demo1.controllers;

import com.uuu.demo1.forms.CourseForm;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class CourseController {
    @GetMapping("/course")
    public String showCourseForm(CourseForm f) {
        return "courseForm";
    }
}
```

<img width="527" height="178" alt="{BFB054C4-1E36-4AB3-88C6-625F963F9567}" src="https://github.com/user-attachments/assets/35e8a3bf-307a-486b-ac53-2c462fef99c1" />

### 增加Form行為

```html
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Course Form</title>
</head>
<body>
<h1>課程表單</h1>

<form th:action="@{/course}" method="post" th:object="${courseForm}">
    <input type="text" th:field="*{courseId}"/>
    <input type="text" th:field="*{courseName}"/>
    <input type="number" th:field="*{duration}"/>
    <button type="submit">Submit</button>
</form>
</body>
</html>
```

```java   
CourseController

package com.uuu.demo1.controllers;

import com.uuu.demo1.forms.CourseForm;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;

@Controller
public class CourseController {
    @GetMapping("/course")
    public String showCourseForm(CourseForm f) {
        f.setCourseId("OO226");
        f.setCourseName("Java and OOP");
        f.setDuration(35);
        return "courseForm";
    }
    @PostMapping("/course")
    public String handleCourseFormSubmit() {
        return "home"; // this is bad, need to fix later
    }
}
```

<img width="610" height="174" alt="{6D70E21B-2C52-4416-824E-31D20D3E07CC}" src="https://github.com/user-attachments/assets/7239ca10-e8f1-4f23-a3db-1a2cd2b1db26" />
點擊按鈕後跳轉   
<img width="744" height="289" alt="{350D0B23-69C7-4416-8B33-FEBEF0F0FFA1}" src="https://github.com/user-attachments/assets/b8646371-0900-45fe-8e3b-04d298d2ae27" />
