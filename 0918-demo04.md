# 0918 Practice - Demo04

### 開啟Spring Initializr 建立專案  

* 填寫專案相關資訊：Group、Artifact、Name、Package name

* 引入相關的Dependencies  
* 下方Generate下載專案
*https://start.spring.io/#!type=maven-project&language=java&platformVersion=3.5.5&packaging=jar&jvmVersion=17&groupId=com.example&artifactId=demo4&name=demo4&description=Demo%20project%20for%20Spring%20Boot&packageName=com.example.demo4&dependencies=devtools,lombok,actuator,web,thymeleaf,h2,data-jdbc

<img width="1197" height="802" alt="{33B24798-A718-4386-BFED-DFBBA7DC5850}" src="https://github.com/user-attachments/assets/2cfe5330-c6f9-44dc-94a9-16cfd286e211" />

### 開啟H2資料庫

* 起本機Springboot
* 打開 http://localhost:8080/h2-console
* 輸入連線資訊 JDBC URL(參考下圖取得方式)、User Name(SA)
<img width="1872" height="264" alt="2025-09-18 14_12_20-demo4 – Demo4Application java" src="https://github.com/user-attachments/assets/65240f83-486a-43b6-b78e-f94b88540ad9" />

<img width="849" height="629" alt="2025-09-18 14_18_10-demo4 – Demo4Application java" src="https://github.com/user-attachments/assets/2995e24f-7742-42a5-a858-3a30ae0a5639" />

### 設定連線資訊

```properties
application.properties

spring.application.name=demo4
spring.datasource.url=jdbc:h2:mem:demo4
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=sa
```

設定後連線資訊就固定了，到畫面上重新輸入後儲存  
<img width="483" height="387" alt="{3793A191-B6F6-4D1E-ABAC-E6FA308563FB}" src="https://github.com/user-attachments/assets/832151cf-2b16-411f-b0a0-02b241cb64f8" />

### JDBC使用

```java
Runner1.java

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.stereotype.Component;

import java.sql.Connection;

@Component
@Slf4j
@Order(1)
public class Runner1 implements CommandLineRunner {
    @Autowired
    NamedParameterJdbcTemplate template;
    private static final String SQL1 = "SELECT 1234+4321";

    @Override
    public void run(String... args) throws Exception {
        log.info("template={}", template);
        log.info("template datasource={}", template.getJdbcTemplate().getDataSource());
        Connection connection1 = template.getJdbcTemplate().getDataSource().getConnection();
        log.info("datasource connection={}", connection1);
        connection1.close();
        SqlParameterSource source = new MapSqlParameterSource();
        Integer intResult = template.queryForObject(SQL1, source, Integer.class);
        log.info("execute {}, result={}", SQL1, intResult);
    }
}
```
<img width="1245" height="235" alt="{72645F02-A7CF-4CA4-9C4D-C455F3EB54E4}" src="https://github.com/user-attachments/assets/51ecc44c-55f7-410f-8945-373d7ef7688b" />

### 移除測試用code & 設定log

```java
Runner1.java

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.stereotype.Component;

import java.sql.Connection;

@Component
@Slf4j
@Order(1)
public class Runner1 implements CommandLineRunner {
    @Autowired
    NamedParameterJdbcTemplate template;
    private static final String SQL1 = "SELECT 1234+4321";

    @Override
    public void run(String... args) throws Exception {
        SqlParameterSource source = new MapSqlParameterSource();
        Integer intResult = template.queryForObject(SQL1, source, Integer.class);
        log.info("execute {}, result={}", SQL1, intResult);
    }
}
```

```properties
application.properties

spring.application.name=demo4
spring.datasource.url=jdbc:h2:mem:demo4
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=sa
#logging.level.root=debug
logging.level.org.springframework.jdbc.core.JdbcTemplate=debug
```

<img width="1271" height="248" alt="{7BD88C17-F572-411C-A621-8DFB191B310E}" src="https://github.com/user-attachments/assets/75ef9ca1-a6df-4ae8-9f2f-54d356ebe790" />


### SQL傳入參數

```java
Runner2.java

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(2)
public class Runner2 implements CommandLineRunner {
    @Autowired
    NamedParameterJdbcTemplate template;
    private static final String SQL1 = "SELECT :a + :b - :c * :d";

    @Override
    public void run(String... args) throws Exception {
        log.info("template={}", template);
        SqlParameterSource source = new MapSqlParameterSource()
                .addValue("a", 100)
                .addValue("b", 200)
                .addValue("c", 300)
                .addValue("d", 400);
        Integer result = template.queryForObject(SQL1, source, Integer.class);
        log.info("calculate {} result={}", SQL1, result);
    }
}
```
<img width="1081" height="163" alt="{DD0CB98F-8F34-488F-A7C8-11268124BDB3}" src="https://github.com/user-attachments/assets/22e5538a-c930-451e-a0f6-b243de9db419" />

### 進行資料庫連線建置

```java
Runner3.java (NEW)

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Component
@Slf4j
@Order(3)
public class Runner3 implements CommandLineRunner {
    @Autowired
    JdbcTemplate template;
    private static final String USER1 = "Mark pwd1";
    private static final String USER2 = "Tim pwd2";
    private static final String USER3 = "Ken pwd3";
    private static final String USER4 = "John pwd4";

    @Override
    public void run(String... args) throws Exception {
//        List<String[]> names = Arrays.asList(USER1,USER2,USER3,USER4)
//                .stream().map(new Function<String, String[]>() {
//                    @Override
//                    public String[] apply(String s) {
//                        return s.split(" ");
//                    }
//                }).collect(Collectors.toList());
        // 刪減過後變下面這樣，可以滑鼠靠近後點Replace
        List<String[]> names = Stream.of(USER1, USER2, USER3, USER4).map(new Function<String, String[]>() {
            @Override
            public String[] apply(String s) {
                return s.split(" ");
            }
        }).toList();
        names.forEach(n -> log.info("轉換回來的是:{}/{}", n[0], n[1]));
    }
}
```

```java
User.java

package com.example.demo4.bean;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    private String username;
    private String password;
}
```
插中斷點後，用DEBUG MODE開啟  
<img width="860" height="448" alt="{1D3BC87C-9C3C-45C9-BB78-26AE349A32DB}" src="https://github.com/user-attachments/assets/3b315649-8ec1-4d9b-b53e-f3f19b1465f8" />  
下方三個點點點開，選擇Trace Current Stream Chain  
<img width="536" height="663" alt="{3AAC17B0-C03D-417A-AA50-8C827FE35B9B}" src="https://github.com/user-attachments/assets/9d030b7c-3d82-4afb-b95e-c3ddefb43481" />  

可以看到資料的關係圖(型態轉變過程)  
<img width="1608" height="554" alt="{7C4103E2-A106-449C-BCDF-54D14F8748B0}" src="https://github.com/user-attachments/assets/90616808-e2fc-4eef-8002-826aa9ed2c94" />  

```java
Runner4.java (NEW)

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(4)
public class Runner4 implements CommandLineRunner {
    @Autowired
    private JdbcTemplate template;
    private static final String CREATE_DDL = "CREATE TABLE users(id SERIAL, username VARCHAR(255), password VARCHAR(255))";
    private static final String DROP_DDL = "DROP TABLE users IF EXISTS";

    @Override
    public void run(String... args) throws Exception {
        template.execute(DROP_DDL);
        template.execute(CREATE_DDL);
    }
}
```

Table有被建置起來，可以開啟H2查看，點選左邊的USERS再按RUN，就會跑出結果
<img width="801" height="369" alt="2025-09-18 15_55_54-demo4 – Runner4 java" src="https://github.com/user-attachments/assets/17195053-4736-4061-a3d9-e6b835853628" />

### 資料庫Table寫入

```java
Runner4.java

package com.example.demo4.runner;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Component
@Slf4j
@Order(4)
public class Runner4 implements CommandLineRunner {
    @Autowired
    private JdbcTemplate template;
    private static final String CREATE_DDL = "CREATE TABLE users(id SERIAL, username VARCHAR(255), password VARCHAR(255))";
    private static final String DROP_DDL = "DROP TABLE users IF EXISTS";
    // sample data
    private static final String USER1 = "Mark pwd1";
    private static final String USER2 = "Tim pwd2";
    private static final String USER3 = "Ken pwd3";
    private static final String USER4 = "John pwd4";
    // inser SQL
    private static final String INSERT_DML = "INSERT INTO users( username, password ) VALUES (?,?)";

    @Override
    public void run(String... args) throws Exception {
        template.execute(DROP_DDL);
        template.execute(CREATE_DDL);
        List<String> originalUsers = Arrays.asList(USER1, USER2, USER3, USER4);
        List<Object[]> users = originalUsers.stream().map(s -> s.split(" ")).collect(Collectors.toList());
        users.forEach(array -> log.info("will insert username:{}, password:{}", array[0], array[1]));
        template.batchUpdate(INSERT_DML, users);
    }
}
```

<img width="1261" height="194" alt="{BF8A0C9D-BAE6-4723-B995-D74F8531432E}" src="https://github.com/user-attachments/assets/fd442c5c-236a-49cc-a736-555bc32416d0" />
<img width="694" height="380" alt="{91E97927-E3FD-4584-809B-FD580D019F32}" src="https://github.com/user-attachments/assets/10c79027-2479-4279-a5ff-4a724c46e4fa" />

### 資料庫Table讀取

```java
Runner4.java

package com.example.demo4.runner;

import com.example.demo4.bean.User;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Component
@Slf4j
@Order(4)
public class Runner4 implements CommandLineRunner {
    @Autowired
    private JdbcTemplate template;
    private static final String CREATE_DDL = "CREATE TABLE users(id SERIAL, username VARCHAR(255), password VARCHAR(255))";
    private static final String DROP_DDL = "DROP TABLE users IF EXISTS";
    // sample data
    private static final String USER1 = "Mark pwd1";
    private static final String USER2 = "Tim pwd2";
    private static final String USER3 = "Ken pwd3";
    private static final String USER4 = "John pwd4";
    // inser SQL
    private static final String INSERT_DML = "INSERT INTO users( username, password ) VALUES (?,?)";
    // query DML
    private static final String SELECT_DML = "SELECT * FROM users";

    @Override
    public void run(String... args) throws Exception {
        template.execute(DROP_DDL);
        template.execute(CREATE_DDL);
        List<String> originalUsers = Arrays.asList(USER1, USER2, USER3, USER4);
        List<Object[]> users = originalUsers.stream().map(s -> s.split(" ")).collect(Collectors.toList());
        users.forEach(array -> log.info("will insert username:{}, password:{}", array[0], array[1]));
        template.batchUpdate(INSERT_DML, users);
//        List<User> totalUsers = template.query(SELECT_DML, (rs, rowNum) -> {
//            log.info("rowNum={},rs={}", rowNum, rs);
//            String username = rs.getString("username");
//            String password = rs.getString("password");
//            log.info("username={},password={}", username, password);
//            return new User(username, password);
//        });
        List<User> totalUsers =template.query(SELECT_DML, (rs,rowNum)->new User(
                rs.getString("username"),rs.getString("password")
        ));
        totalUsers.forEach(x -> log.info("total user, current user={}", x));
    }
}
```

<img width="1232" height="272" alt="{BA6C306F-5F03-4C8B-B9E4-6A76E8FB2DFB}" src="https://github.com/user-attachments/assets/fa4ae285-d990-44e9-a66e-8df45b547292" />  


### 資料庫Table讀取單筆

```java
Runner4.java

package com.example.demo4.runner;

import com.example.demo4.bean.User;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Component
@Slf4j
@Order(4)
public class Runner4 implements CommandLineRunner {
    @Autowired
    private JdbcTemplate template;
    private static final String CREATE_DDL = "CREATE TABLE users(id SERIAL, username VARCHAR(255), password VARCHAR(255))";
    private static final String DROP_DDL = "DROP TABLE users IF EXISTS";
    // sample data
    private static final String USER1 = "Mark pwd1";
    private static final String USER2 = "Tim pwd2";
    private static final String USER3 = "Ken pwd3";
    private static final String USER4 = "John pwd4";
    // inser SQL
    private static final String INSERT_DML = "INSERT INTO users( username, password ) VALUES (?,?)";
    // query DML
    private static final String SELECT_DML = "SELECT * FROM users";
    private static final String SELECT_DML2 = "SELECT id, username, password FROM users WHERE username = ?";

    @Override
    public void run(String... args) throws Exception {
        template.execute(DROP_DDL);
        template.execute(CREATE_DDL);
        List<String> originalUsers = Arrays.asList(USER1, USER2, USER3, USER4);
        List<Object[]> users = originalUsers.stream().map(s -> s.split(" ")).collect(Collectors.toList());
        users.forEach(array -> log.info("will insert username:{}, password:{}", array[0], array[1]));
        template.batchUpdate(INSERT_DML, users);
//        List<User> totalUsers = template.query(SELECT_DML, (rs, rowNum) -> {
//            log.info("rowNum={},rs={}", rowNum, rs);
//            String username = rs.getString("username");
//            String password = rs.getString("password");
//            log.info("username={},password={}", username, password);
//            return new User(username, password);
//        });
        List<User> totalUsers = template.query(SELECT_DML, (rs, rowNum) -> new User(
                rs.getString("username"), rs.getString("password")
        ));
        totalUsers.forEach(x -> log.info("total user, current user={}", x));
        template.query(SELECT_DML, (rs, rowNum) -> new User(
                rs.getString("username"), rs.getString("password")
        )).forEach(user -> log.info("in stream current user={}", user));
        User user = template.queryForObject(SELECT_DML2, (rs, rowNum) -> new User(
                rs.getString("username"), rs.getString("password")
        ), new Object[]{"Ken"});
        log.info("query 'Ken', result={}", user);
    }
}
```

### 將SQL移到外面

```SQL
schema.sql

CREATE TABLE users2(
id INTEGER PRIMARY KEY AUTO_INCREMENT,
username VARCHAR(255),
password VARCHAR(255)
);
```

檔案一定要放在這個路徑(src/main/resources/)，放完直接啟動就好了
<img width="517" height="317" alt="2025-09-18 16_56_34-demo4 – schema sql" src="https://github.com/user-attachments/assets/56d203c4-ff23-4ae3-ace0-f59f0b834b69" />

<img width="636" height="347" alt="{D6ADA618-9E2F-417B-9A2F-55C6DA69C521}" src="https://github.com/user-attachments/assets/be634a22-f976-4138-9d1e-ab76e078ca7c" />
