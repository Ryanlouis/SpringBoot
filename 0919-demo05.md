# 0919 Practice - Demo05

### 初始新專案H2設定


```properties
application.properties

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
```

### 使用JPA創建TABLE

新增customer entity
@Entity 這一個註解，用於標記Java 類別是為JPA（Java Persistence API）實體類別

```java
Customer.java

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
package com.example.demo5.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Customer {
    @Id
    @GeneratedValue
    private Long id;
    @Column(nullable = false)
    private String firstName;
    @Column(nullable = false)
    private String lastName;
}

```


新增 CustomerRepository 與 Customer 建立連接
```java
CustomerRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerRepository extends JpaRepository<Customer,Long> {
}

```

### 使用CustomerRunner 藉由CustomerRepository來新增資料
```java
CustomerRunner.java

package com.example.demo5.runner;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(1)
public class CustomerRunner implements CommandLineRunner {
    @Autowired
    private CustomerRepository repository;

    @Override
    public void run(String... args) throws Exception {
        log.info("repository={}", repository);
        Customer c1 = new Customer();
        c1.setFirstName("Mark");
        c1.setLastName("Ho");
        repository.save(c1);
    }
}

```
<img width="532" height="289" alt="{DD90AA97-F36D-430F-AE30-9CA4687720CE}" src="https://github.com/user-attachments/assets/95643ac1-6cbd-499c-908b-3bd40d1ea0c5" />

### log改成log4j模式


```properties
application.properties

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
#
#spring.jpa.show-sql=true
#spring.jpa.properties.hibernate.format_sql=true
#
logging.level.org.hibernate.type.EnumType=TRACE
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.orm.jdbc.bind=TRACE
```
<img width="1489" height="130" alt="{B227AF34-E3C3-48BC-86CD-55B28E9BC672}" src="https://github.com/user-attachments/assets/61f92288-f676-4b8c-a071-cd2b49235b4f" />

### 使用JPQL作客製化查詢

CustomerRepository新增JPQL設定

```java
CustomerRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface CustomerRepository extends JpaRepository<Customer, Long> {
    @Query("SELECT x FROM Customer x ORDER BY x.lastName, x.firstName")
    List<Customer> findAllOrderByName();
}
```

Customer新增constructor

```java
Customer.java

package com.example.demo5.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Customer {
    @Id
    @GeneratedValue
    private Long id;
    @Column(nullable = false)
    private String firstName;
    @Column(nullable = false)
    private String lastName;

    public Customer(String lastName, String firstName) {
        this.lastName = lastName;
        this.firstName = firstName;
    }
}
```

CustomerRunner呼叫CustomerRepository執行JPQL

```java
CustomerRunner.java

package com.example.demo5.runner;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(1)
public class CustomerRunner implements CommandLineRunner {
    @Autowired
    private CustomerRepository repository;

    @Override
    public void run(String... args) throws Exception {
        log.info("repository={}", repository);
        Customer c1 = new Customer();
        c1.setFirstName("Mark");
        c1.setLastName("Ho");
        repository.save(c1);
        addMoreCustomers();
        callJpaQuery();
    }

    private void callJpaQuery() {
        repository.findAllOrderByName().forEach(c -> log.info("query order by name:{}", c));
    }

    private void addMoreCustomers() {
        repository.save(new Customer("Ho", "Peter"));
        repository.save(new Customer("Chen", "Peter"));
        repository.save(new Customer("Chen", "Mary"));
        repository.save(new Customer("Lee", "Mary"));
        repository.save(new Customer("Lee", "Ken"));
    }
}
```


### 建立抽象service層讓JPA連到Restful

在service下建立CustomerService

```java
CustomerService.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;

import java.util.List;

public interface CustomerService {
    List<Customer> findAll();
    Customer findOne(Long id);
    Customer create(Customer customer);
    Customer update(Customer customer);
    void delete(Long id);
}
```

多建立一個CustomerSimpleRepository 方便檢視


```java
CustomerSimpleRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.repository.CrudRepository;

public interface CustomerSimpleRepository extends CrudRepository<Customer, Long> {
}
```

### 在service下實做出JPAService
```java
CustomerJPAService.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Optional;

public class CustomerJPAService implements CustomerService {
    @Autowired
    private CustomerRepository repository;

    @Override
    public List<Customer> findAll() {
        return repository.findAll();
    }

    @Override
    public Customer findOne(Long id) {
        Optional<Customer> optionalCustomer = repository.findById(id);
        if (optionalCustomer.isPresent()) {
            return optionalCustomer.get();
        }
        return null;
    }

    @Override
    public Customer create(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public Customer update(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public void delete(Long id) {
        repository.deleteById(id);
    }
}
```
### 實做CustomerRestController來呼叫CustomerJPAService

```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }
}
```
另外記得把CustomerJPAService加上@Service
```java
CustomerJPAServicer.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
@Service
public class CustomerJPAService implements CustomerService {
    @Autowired
    private CustomerRepository repository;

    @Override
    public List<Customer> findAll() {
        return repository.findAll();
    }

    @Override
    public Customer findOne(Long id) {
        Optional<Customer> optionalCustomer = repository.findById(id);
        if (optionalCustomer.isPresent()) {
            return optionalCustomer.get();
        }
        return null;
    }

    @Override
    public Customer create(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public Customer update(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public void delete(Long id) {
        repository.deleteById(id);
    }
}
```
### CustomerRestController新增"新增資料"功能
postCustomer增加 @ResponseStatus(HttpStatus.CREATED)是為了讓回傳為201，如果不加也沒影響但會回200。
```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }
}
```

<img width="682" height="682" alt="{3C79E06D-141D-43A4-AFBE-0D506ABCB4B9}" src="https://github.com/user-attachments/assets/cfa3526e-0091-4fce-af0e-fbede6165e6a" />

### CustomerRestController新增抓取path當參數"查詢資料"功能


```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }
}
```
<img width="638" height="696" alt="{36E7F8E8-5FB7-4F1C-B977-B9D6D5DF44DE}" src="https://github.com/user-attachments/assets/f87524a2-f9bd-4fc4-abcb-fba3f6da0317" />


### CustomerRestController新增抓取path當參數以及put資料"更新資料"功能


```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }
}
```


### CustomerRestController新增抓取path當參數"刪除資料"功能
如果不需要有內容為求精確可以設成HttpStatus.NO_CONTENT 回傳204

```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.PUT)
    Customer putCustomer(@PathVariable Long id, @RequestBody Customer c) {
        c.setId(id);
        return service.update(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.DELETE)
    @ResponseStatus(HttpStatus.NO_CONTENT)
    void deleteCustomer(@PathVariable Long id) {
        service.delete(id);
    }
}
```

### 新增openapi產生swagger ui頁

https://mvnrepository.com/artifact/org.springdoc/springdoc-openapi-starter-webmvc-ui

```xml
pom.xml
<!-- https://mvnrepository.com/artifact/org.springdoc/springdoc-openapi-starter-webmvc-ui -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.8.13</version>
        </dependency>
```
swagger ui網址
http://localhost:8080/swagger-ui/index.html


### Exception例外處理

### 新增OopsController 但基本上還是很怪

```java
OopsController.java

package com.example.demo5.controller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("api/oops")
@Slf4j
public class OopsController {
    @RequestMapping(method = RequestMethod.GET)
    public String status() {
        try {

            int x = 5 / 0;
        } catch (ArithmeticException ae) {
            log.info("5/0 exception error as:{}", ae);
            return "oops!";
        }
        return "status is good";
    }
    @GetMapping("/again")
    public String status2() {
        throw new RuntimeException("haha");
    }
}
```
### OopsController 新增 status3  顯示了type=Bad Request, status=400，但基本上還是很怪，因為還是包含了一堆系統錯誤
```txt
There was an unexpected error (type=Bad Request, status=400).
explain exception handling
com.example.demo5.exception.OopsException: explain exception handling
```


```java
OopsController.java

package com.example.demo5.controller;

import com.example.demo5.exception.OopsException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("api/oops")
@Slf4j
public class OopsController {
    @RequestMapping(method = RequestMethod.GET)
    public String status() {
        try {

            int x = 5 / 0;
        } catch (ArithmeticException ae) {
            log.info("5/0 exception error as:{}", ae);
            return "oops!";
        }
        return "status is good";
    }
    @GetMapping("/again")
    public String status2() {
        throw new RuntimeException("haha");
    }
    @GetMapping("/explain")
    public String status3() {
        throw new OopsException("explain exception handling");
    }
}
```
### 新增GlobalResponseEntityExceptionHandler 來把多餘的訊息處理掉
只呈現
```json
{
  "oopsResponse": "explain exception handling"
}
```

```java
GlobalResponseEntityExceptionHandler.java

package com.example.demo5.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

@ControllerAdvice
public class GlobalResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {
    @ExceptionHandler
    public final ResponseEntity<Object> handleOopsException(OopsException e, WebRequest w) {
        OopsResponse response = new OopsResponse(e.getMessage());
        return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
    }

}
```

### 修改OopsResponse 、GlobalResponseEntityExceptionHandler 來呈現多層次資訊
呈現
```json
{
  "oopsReason": "explain exception handling",
  "level": 5,
  "owner": "Mark Ho"
}
```

```java
OopsResponse.java

package com.example.demo5.exception;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class OopsResponse {
    private String oopsReason;
    private Integer level;
    private String owner;
}
```

```java
GlobalResponseEntityExceptionHandler.java

package com.example.demo5.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

@ControllerAdvice
public class GlobalResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {
    @ExceptionHandler
    public final ResponseEntity<Object> handleOopsException(OopsException e, WebRequest w) {
        OopsResponse response = new OopsResponse(e.getMessage(), 5, "Mark Ho");
        return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
    }

}
```

### 修改OopsController 新增NormalResult 、BadResult 來呈現http不同的狀態碼
呈現
```json
{
  "id": -1,
  "cause": "id should larger than -1"
}
```
```json
{
  "id": 0,
  "result": "this is OK"
}
```
```java
NormalResult.java

package com.example.demo5.exception;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class NormalResult {
    private Long id;
    private String result;
}
```

```java
BadResult.java

package com.example.demo5.exception;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class BadResult {
    private Long id;
    private String cause;
}
```

```java
OopsController.java

package com.example.demo5.controller;

import com.example.demo5.exception.BadResult;
import com.example.demo5.exception.NormalResult;
import com.example.demo5.exception.OopsException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("api/oops")
@Slf4j
public class OopsController {
    @RequestMapping(method = RequestMethod.GET)
    public String status() {
        try {

            int x = 5 / 0;
        } catch (ArithmeticException ae) {
            log.info("5/0 exception error as:{}", ae);
            return "oops!";
        }
        return "status is good";
    }

    @GetMapping("/again")
    public String status2() {
        throw new RuntimeException("haha");
    }

    @GetMapping("/explain")
    public String status3() {
        throw new OopsException("explain exception handling");
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    public ResponseEntity<?> status4(@PathVariable Long id) {
        if (id <= -1) {
            BadResult b1 = new BadResult(id, "id should larger than -1");
            return new ResponseEntity<>(b1, HttpStatus.BAD_REQUEST);
        } else {
            NormalResult r1 = new NormalResult(id, "this is OK");
            return new ResponseEntity<>(r1, HttpStatus.OK);
        }

    }
}
```
### Sprint Rest Test

### 新增bean:HomeResponse、controller:RootController來實作一個簡單的端點

```java
HomeResponse.java

package com.example.demo5.bean;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class HomeResponse {
    private int id;
    private String message;
}
```

```java
RootController.java

package com.example.demo5.controller;

import com.example.demo5.bean.HomeResponse;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class RootController {
    @GetMapping("/")
    public ResponseEntity<?> home() {
        HomeResponse r1 = new HomeResponse(555,"OK");
        return new ResponseEntity<>(r1, HttpStatus.OK);
    }
}
```
### 新增Rest1Test進行測試
測試框架使用@SpringBootTest  
因為原本的服務可能還開著，為了避免衝到原本的PORT，因此包含此參數藉此避開原本的8080  
webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT  
showRootIsOK 預期回傳為String  
showRootIsOKForHomeResponse 預期回傳為HomeResponse  
parseRootResponse使用JsonPath將結果(String)解析成DocumentContext  
JsonPath是一种简单的方法来提取给定JSON文档的部分内容，還可用正則來撈資料，JsonPath在spring-boot-starter-test:jar裡。
```java
Rest1Test.java

package com.example.demo5;

import com.example.demo5.bean.HomeResponse;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.ResponseEntity;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class Rest1Test {
    @Autowired
    TestRestTemplate template;

    @Test
    public void checkTemplateIsValid() {
        System.out.printf("template=%s\n", template);
    }

    @Test
    public void showRootIsOK() {
        ResponseEntity<String> response = template.getForEntity("/", String.class);
        System.out.printf("response status=[%s], body=%s\n", response.getStatusCode(), response.getBody());
    }

    @Test
    public void parseRootResponse() {
        ResponseEntity<String> response = template.getForEntity("/", String.class);
        DocumentContext rootContext = JsonPath.parse(response.getBody());
        Number id = rootContext.read("$.id");
        Assertions.assertNotNull(id);
        Assertions.assertEquals(555, id.intValue());
        String message = rootContext.read("$.message");
        Assertions.assertNotNull(message);
        Assertions.assertEquals("OK", message);
        //Object error = rootContext.read("$.error");
        //Assertions.assertNull(error);
    }

    @Test
    public void showRootIsOKForHomeResponse() {
        ResponseEntity<HomeResponse> response = template.getForEntity("/", HomeResponse.class);
        HomeResponse testHomeResponse = response.getBody();
        System.out.printf("response status=[%s], body=%s\n", response.getStatusCode(), testHomeResponse);
        Assertions.assertEquals(555, testHomeResponse.getId());
        Assertions.assertEquals("OK",testHomeResponse.getMessage());

    }

    
}
```
### 使用WebTestClient-需要使用webflux於測試時使用  

注意使用@LocalServerPort時必須是真實web環境，也就是@SpringBootTest的webEnvironment應為RANDOM_PORT或DEFINED_PORT。  
若為MOCK則mock web環境無法正確注入。

```xml
pom.xml
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
            <scope>test</scope>  <!-- 自己加上去的 僅限測試 -->
</dependency>
```

```java
Ret2Test.java

package com.example.demo5;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.test.web.reactive.server.WebTestClient;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class Ret2Test {
    @LocalServerPort
    int randomServerPort;
    WebTestClient client;

    @BeforeEach
    public void prepare() {
        client = WebTestClient.bindToServer()
                .baseUrl("http://localhost:" + randomServerPort).build();
        System.out.printf("base port=%d\n", randomServerPort);
    }

    @Test
    public void clientIsValid() {
        Assertions.assertNotNull(client);
    }

    @Test
    public void checkRootIsOK() {
        client.get().uri("/").exchange().expectStatus().isOk();
    }
    @Test
    public void checkRootIdIsNotEmpty() {
        client.get().uri("/").exchange().expectBody().jsonPath("$.id").isNotEmpty();
    }
    @Test
    public void checkRootIdIs555() {
        client.get().uri("/").exchange().expectBody().jsonPath("$.id").isEqualTo(555);
    }
    @Test
    public void checkRootMessageIsOK() {
        client.get().uri("/").exchange().expectBody().jsonPath("$.message").isEqualTo("OK");
    }

    @Test
    public void checkAuthIsNotOK() {
        client.get().uri("/auth").exchange().expectStatus().isNotFound();
    }
}

```
