# 0919 Practice - Demo05

### 初始新專案H2設定


```properties
application.properties

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
```

### 使用JPA創建TABLE

新增customer entity
@Entity 這一個註解，用於標記Java 類別是為JPA（Java Persistence API）實體類別

```java
Customer.java

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
package com.example.demo5.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Customer {
    @Id
    @GeneratedValue
    private Long id;
    @Column(nullable = false)
    private String firstName;
    @Column(nullable = false)
    private String lastName;
}

```


新增 CustomerRepository 與 Customer 建立連接
```java
CustomerRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerRepository extends JpaRepository<Customer,Long> {
}

```

### 使用CustomerRunner 藉由CustomerRepository來新增資料
```java
CustomerRunner.java

package com.example.demo5.runner;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(1)
public class CustomerRunner implements CommandLineRunner {
    @Autowired
    private CustomerRepository repository;

    @Override
    public void run(String... args) throws Exception {
        log.info("repository={}", repository);
        Customer c1 = new Customer();
        c1.setFirstName("Mark");
        c1.setLastName("Ho");
        repository.save(c1);
    }
}

```
<img width="532" height="289" alt="{DD90AA97-F36D-430F-AE30-9CA4687720CE}" src="https://github.com/user-attachments/assets/95643ac1-6cbd-499c-908b-3bd40d1ea0c5" />

### log改成log4j模式


```properties
application.properties

spring.application.name=demo5
spring.datasource.url=jdbc:h2:mem:demo5
spring.datasource.username=sa
spring.datasource.password=sa
#
#spring.jpa.show-sql=true
#spring.jpa.properties.hibernate.format_sql=true
#
logging.level.org.hibernate.type.EnumType=TRACE
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.orm.jdbc.bind=TRACE
```
<img width="1489" height="130" alt="{B227AF34-E3C3-48BC-86CD-55B28E9BC672}" src="https://github.com/user-attachments/assets/61f92288-f676-4b8c-a071-cd2b49235b4f" />

### 使用JPQL作客製化查詢

CustomerRepository新增JPQL設定

```java
CustomerRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface CustomerRepository extends JpaRepository<Customer, Long> {
    @Query("SELECT x FROM Customer x ORDER BY x.lastName, x.firstName")
    List<Customer> findAllOrderByName();
}
```

Customer新增constructor

```java
Customer.java

package com.example.demo5.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Customer {
    @Id
    @GeneratedValue
    private Long id;
    @Column(nullable = false)
    private String firstName;
    @Column(nullable = false)
    private String lastName;

    public Customer(String lastName, String firstName) {
        this.lastName = lastName;
        this.firstName = firstName;
    }
}
```

CustomerRunner呼叫CustomerRepository執行JPQL

```java
CustomerRunner.java

package com.example.demo5.runner;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(1)
public class CustomerRunner implements CommandLineRunner {
    @Autowired
    private CustomerRepository repository;

    @Override
    public void run(String... args) throws Exception {
        log.info("repository={}", repository);
        Customer c1 = new Customer();
        c1.setFirstName("Mark");
        c1.setLastName("Ho");
        repository.save(c1);
        addMoreCustomers();
        callJpaQuery();
    }

    private void callJpaQuery() {
        repository.findAllOrderByName().forEach(c -> log.info("query order by name:{}", c));
    }

    private void addMoreCustomers() {
        repository.save(new Customer("Ho", "Peter"));
        repository.save(new Customer("Chen", "Peter"));
        repository.save(new Customer("Chen", "Mary"));
        repository.save(new Customer("Lee", "Mary"));
        repository.save(new Customer("Lee", "Ken"));
    }
}
```


### 建立抽象service層讓JPA連到Restful

在service下建立CustomerService

```java
CustomerService.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;

import java.util.List;

public interface CustomerService {
    List<Customer> findAll();
    Customer findOne(Long id);
    Customer create(Customer customer);
    Customer update(Customer customer);
    void delete(Long id);
}
```

多建立一個CustomerSimpleRepository 方便檢視


```java
CustomerSimpleRepository.java

package com.example.demo5.repository;

import com.example.demo5.entity.Customer;
import org.springframework.data.repository.CrudRepository;

public interface CustomerSimpleRepository extends CrudRepository<Customer, Long> {
}
```

### 在service下實做出JPAService
```java
CustomerJPAService.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Optional;

public class CustomerJPAService implements CustomerService {
    @Autowired
    private CustomerRepository repository;

    @Override
    public List<Customer> findAll() {
        return repository.findAll();
    }

    @Override
    public Customer findOne(Long id) {
        Optional<Customer> optionalCustomer = repository.findById(id);
        if (optionalCustomer.isPresent()) {
            return optionalCustomer.get();
        }
        return null;
    }

    @Override
    public Customer create(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public Customer update(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public void delete(Long id) {
        repository.deleteById(id);
    }
}
```
### 實做CustomerRestController來呼叫CustomerJPAService

```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }
}
```
另外記得把CustomerJPAService加上@Service
```java
CustomerJPAServicer.java

package com.example.demo5.service;

import com.example.demo5.entity.Customer;
import com.example.demo5.repository.CustomerRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
@Service
public class CustomerJPAService implements CustomerService {
    @Autowired
    private CustomerRepository repository;

    @Override
    public List<Customer> findAll() {
        return repository.findAll();
    }

    @Override
    public Customer findOne(Long id) {
        Optional<Customer> optionalCustomer = repository.findById(id);
        if (optionalCustomer.isPresent()) {
            return optionalCustomer.get();
        }
        return null;
    }

    @Override
    public Customer create(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public Customer update(Customer customer) {
        return repository.save(customer);
    }

    @Override
    public void delete(Long id) {
        repository.deleteById(id);
    }
}
```
### CustomerRestController新增"新增資料"功能
postCustomer增加 @ResponseStatus(HttpStatus.CREATED)是為了讓回傳為201，如果不加也沒影響但會回200。
```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }
}
```

<img width="682" height="682" alt="{3C79E06D-141D-43A4-AFBE-0D506ABCB4B9}" src="https://github.com/user-attachments/assets/cfa3526e-0091-4fce-af0e-fbede6165e6a" />

### CustomerRestController新增抓取path當參數"查詢資料"功能


```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }
}
```
<img width="638" height="696" alt="{36E7F8E8-5FB7-4F1C-B977-B9D6D5DF44DE}" src="https://github.com/user-attachments/assets/f87524a2-f9bd-4fc4-abcb-fba3f6da0317" />


### CustomerRestController新增抓取path當參數以及put資料"更新資料"功能


```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }
}
```
![Uploading {3685EC10-1472-4C5E-AD5C-29A6191D7491}.png…]()

### CustomerRestController新增抓取path當參數"刪除資料"功能
如果不需要有內容為求精確可以設成HttpStatus.NO_CONTENT 回傳204

```java
CustomerRestController.java

package com.example.demo5.controller;

import com.example.demo5.entity.Customer;
import com.example.demo5.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("api/customers")
@CrossOrigin
public class CustomerRestController {
    @Autowired
    CustomerService service;

    @GetMapping("/all")
    List<Customer> getCustomer() {
        return service.findAll();
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(method = RequestMethod.POST)
    Customer postCustomer(@RequestBody Customer c) {
        return service.create(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.GET)
    Customer getACustomer(@PathVariable Long id) {
        return service.findOne(id);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.PUT)
    Customer putCustomer(@PathVariable Long id, @RequestBody Customer c) {
        c.setId(id);
        return service.update(c);
    }

    @RequestMapping(value = "{id}", method = RequestMethod.DELETE)
    @ResponseStatus(HttpStatus.NO_CONTENT)
    void deleteCustomer(@PathVariable Long id) {
        service.delete(id);
    }
}
```

