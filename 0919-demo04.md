# 0919 Practice - Demo04

### 寫入資料
src/main/resources/data.sql

```sql
data.sql

INSERT INTO users2 (username,password) VALUES ('Mark','PWD1');
INSERT INTO users2 (username,password) VALUES ('Tim','PWD2');
INSERT INTO users2 (username,password) VALUES ('Ken','PWD3');
INSERT INTO users2 (username,password) VALUES ('John','PWD4');
```
h2 在 embeded的模式下 一定會先執行schema.sql(DDL)之後再執行data.sql(DML) 
因為是in-memory模式一定要有TABLE才能操作資料


###  將in-memory改寫到檔案

原本是 jdbc:h2 mem:(db名)
spring.datasource.url=jdbc:h2:mem:demo4
改寫成 jdbc:h2:(實體路徑)
spring.datasource.url=jdbc:h2:c:/Users/Admin/demo4

```properties
application.properties

spring.application.name=demo4
#spring.datasource.url=jdbc:h2:mem:demo4
spring.datasource.url=jdbc:h2:c:/Users/Admin/demo4
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=sa
#logging.level.root=debug
logging.level.org.springframework.jdbc.core.JdbcTemplate=debug
```

dir c:\Users\Admin\demo4.*

<img width="628" height="178" alt="{5E75DADB-6929-4438-9C48-E9329C028862}" src="https://github.com/user-attachments/assets/5a42fcfb-b46a-4c49-83ef-6fbf584da0a1" />


查找h2的版本下載console
.\mvnw dependency:tree

<img width="412" height="39" alt="{447118E9-BEBD-4717-A95C-74B8E29A4ECB}" src="https://github.com/user-attachments/assets/bb13bf00-4232-45bd-b32a-744f0e991707" />

:h2:jar:2.3.23

<img width="850" height="419" alt="{F5ACE121-9365-4631-9F7C-8BFFF0E3A0DA}" src="https://github.com/user-attachments/assets/1e822cb0-4b08-472e-b570-a5890bb9edc8" />

explorer ==> C:\Users\Admin\Downloads\h2-2024-08-11\h2\bin

啟動service h2/bin/h2w 可以在服務未啟動時去檢視DB內容  (但會與springboot 互卡)

<img width="676" height="300" alt="{AFDD7C17-F8A3-4F8C-8FDC-E9159077F359}" src="https://github.com/user-attachments/assets/09b2625f-019a-45ba-940c-904a4cc14ca9" />

通常本機h2的網址是
http://localhost:8080/h2-console
開啟時記得要停spring


<img width="668" height="410" alt="{7B7832DE-AE13-4B7B-8CC4-03000F176CA8}" src="https://github.com/user-attachments/assets/46fb824a-5ef2-4c89-8e09-5c858ce840c7" />


###  如果也想要啟動時也帶入schema.sql和data.sql

application.properties新增設定 spring.sql.init.mode=always 

```properties
application.properties

spring.application.name=demo4
#spring.datasource.url=jdbc:h2:mem:demo4
spring.datasource.url=jdbc:h2:c:/Users/Admin/demo4
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=sa
#logging.level.root=debug
logging.level.org.springframework.jdbc.core.JdbcTemplate=debug
spring.sql.init.mode=always
```


但原本的schema.sql要調整成每次都要記得刪掉 不然會重複


```sql
schema.sql

DROP TABLE users2 IF EXISTS;

CREATE TABLE users2(
id INTEGER PRIMARY KEY AUTO_INCREMENT,
username VARCHAR(255),
password VARCHAR(255)
);
```

###  新增Runner5.java來查詢user2的結果

```java
Runner5.java

package com.example.demo4.runner;

import com.example.demo4.bean.User;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.stereotype.Component;

@Component
@Slf4j
@Order(5)
public class Runner5 implements CommandLineRunner {
    @Autowired
    private NamedParameterJdbcTemplate template;
    private static final String SQL = "SELECT id, username, password FROM users2 WHERE id=:id";

    @Override
    public void run(String... args) throws Exception {
        SqlParameterSource source = new MapSqlParameterSource()
                .addValue("id", 2);
        User user = template.queryForObject(SQL, source, (rs, rowNum) -> new User(
                rs.getString("username"), rs.getString("password")
        ));
        log.info("get user with id 2 is -->{}", user);

    }
}
```
###  如果要刪本機h2 要用jconsole找h2程式使用的javaw.exe
open jconsole
